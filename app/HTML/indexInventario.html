<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FarmStock - Inventario</title>
    <link rel="stylesheet" href="../CSS/iventario.css" />
    <link rel="stylesheet" href="/FarmStock/app/CSS/darkmode.css">

</head>

<body>
    <div class="window-controls">
        <button id="minimize" title="Minimizar">
    <svg viewBox="0 0 10 10">
        <rect x="2" y="6" width="6" height="1" fill="currentColor"/>
    </svg>
    </button>

        <button id="maximize" title="Maximizar">
    <svg viewBox="0 0 10 10">
        <rect x="2" y="2" width="6" height="6" fill="none" stroke="currentColor" stroke-width="1"/>
    </svg>
    </button>

        <button id="close" title="Cerrar">
    <svg viewBox="0 0 10 10">
        <line x1="2" y1="2" x2="8" y2="8" stroke="currentColor" stroke-width="1.5"/>
        <line x1="8" y1="2" x2="2" y2="8" stroke="currentColor" stroke-width="1.5"/>
    </svg>
    </button>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="top-section">
                <div class="logo">
                    <img src="../imagenes/Logo.png" alt="Logo del sitio" />
                </div>
                <ul class="menu-modulos">
                    <li><a href="../HTML/index.html">Registro Herramientas</a></li>
                    <li><a href="../HTML/registro-salida.html">Historial de herramientas</a></li>
                    <li><a href="../HTML/indexInventario.html" class="active">Inventario</a></li>
                    <li><a href="notificaciones.html">Notificaciones</a></li>
                    <li><a href="../HTML/estats.html">Estad√≠sticas</a></li>
                </ul>
            </div>
            <div class="sidebar-bottom">
                <a href="quienes-somos.html" class="somos">üë• Qui√©nes Somos</a>
                <div class="night-mode">
                    <span>üåô Modo noche</span>
                </div>
            </div>
        </aside>

        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Usuario arriba -->
            <div class="bienvenida">
                <img src="../imagenes/Maria.png" alt="Foto de usuario" class="foto-usuario" />
                <p><strong>¬°Hola Maria!</strong></p>
            </div>

            <!-- Panel blanco -->
            <div class="cuadro-visual">
                <div class="encabezado-panel">
                    <h1>Inventario</h1>
                    <div class="menu-verde-completo">
                        <span class="menu-verde-label">Ver desde</span>
                        <select id="filtroTiempo" class="menu-verde-select">
              <option value="hoy">Hoy</option>
              <option value="semana">√öltima semana</option>
              <option value="mes">√öltimo mes</option>
              <option value="3meses" selected>3 meses</option>
              <option value="todo">Todo</option>
            </select>
                    </div>
                </div>

                <!-- Aqu√≠ se insertar√°n las tarjetas -->
                <div id="inventarioLista" class="tarjetas-container"></div>
            </div>
        </main>
    </div>

    <!-- Script para mostrar herramientas -->
    <script src="../modo-oscuro.js"></script>
    <script>
        const API_HERRAMIENTAS = "http://localhost:8080/herramienta";

        async function obtenerHerramientasBackend() {
            try {
                const res = await fetch(API_HERRAMIENTAS);
                if (!res.ok) throw new Error("respuesta no ok");
                const datos = await res.json();
                if (!Array.isArray(datos)) return [];
                return datos;
            } catch (err) {
                console.warn("No se pudo obtener del backend, usando localStorage:", err);
                return null; // indica fallo para usar fallback
            }
        }

        function normalizar(h) {
            return {
                id: h.id_herramienta ?? h.id ?? h.Id ?? h._id ?? "",
                nombre: h.nombre ?? h.nombreHerramienta ?? "Sin nombre",
                estado: h.estado ?? h.estadoHerramienta ?? "Desconocido",
                tipo: h.tipo ?? h.tipoHerramienta ?? "",
                ubicacion: h.ubicacion ?? h.ubicacionHerramienta ?? "",
                fecha: h.fecha_registro ?? h.fecha ?? h.fechaIngreso ?? "",
                lote: h.numero_lote ?? h.lote ?? h.loteHerramienta ?? "",
                cantidad: h.cantidad ?? h.cant ?? 0,
                descripcion: h.descripcion ?? h.desc ?? ""
            };
        }

        async function mostrarInventario(filtro = "3meses") {
            let herramientas = await obtenerHerramientasBackend();
            if (herramientas === null) {
                // fallback a localStorage si el backend no responde
                herramientas = JSON.parse(localStorage.getItem("herramientas")) || [];
            }

            // normalizar arreglo
            herramientas = herramientas.map(normalizar);

            const contenedor = document.getElementById("inventarioLista");
            contenedor.innerHTML = "";

            const hoy = new Date();

            const tarjetas = herramientas.filter(h => {
                if (!h.fecha) return true;
                const fechaHerramienta = new Date(h.fecha);
                if (filtro === "hoy") {
                    return fechaHerramienta.toDateString() === hoy.toDateString();
                } else if (filtro === "semana") {
                    const semanaPasada = new Date(); semanaPasada.setDate(hoy.getDate() - 7);
                    return fechaHerramienta >= semanaPasada;
                } else if (filtro === "mes") {
                    const mesPasado = new Date(); mesPasado.setMonth(hoy.getMonth() - 1);
                    return fechaHerramienta >= mesPasado;
                } else if (filtro === "3meses") {
                    const tresMeses = new Date(); tresMeses.setMonth(hoy.getMonth() - 3);
                    return fechaHerramienta >= tresMeses;
                }
                return true;
            }).map(h => {
                return `
            <div class="tarjeta herramienta-card">
              <h3>üõ†Ô∏è ${h.nombre}</h3>
              <p><strong>Estado:</strong> ${h.estado}</p>
              <p><strong>Tipo:</strong> ${h.tipo}</p>
              <p><strong>Ubicaci√≥n:</strong> ${h.ubicacion}</p>
              <p><strong>Fecha ingreso:</strong> ${h.fecha || "‚Äî"}</p>
              <p><strong>Lote:</strong> ${h.lote || "‚Äî"}</p>
              <p><strong>Cantidad:</strong> ${h.cantidad}</p>
              <p><strong>Descripci√≥n:</strong> ${h.descripcion || "Sin descripci√≥n"}</p>

              <div class="acciones">
                <button class="editar" onclick="editarHerramienta('${h.id}')">Editar</button>
                <button class="eliminar" onclick="eliminarHerramienta('${h.id}')">Eliminar</button>
              </div>
            </div>
          `;
            });

            contenedor.innerHTML = tarjetas.join("");

            if (contenedor.innerHTML === "") {
                contenedor.innerHTML = "<p>No hay herramientas registradas en este rango de tiempo.</p>";
            }
        }

        // funciones stub para editar/eliminar (implementa seg√∫n backend)
        function editarHerramienta(id) {
            alert("Editar herramienta: " + id);
            // TODO: abrir modal o navegar a formulario de edici√≥n
        }

        function eliminarHerramienta(id) {
            if (!confirm("¬øEliminar herramienta id " + id + "?")) return;
            // Intentar eliminar por API; si falla, avisar y recargar lista
            fetch(`${API_HERRAMIENTAS}/${id}`, { method: "DELETE" })
                .then(r => {
                    if (r.ok) {
                        mostrarInventario(document.getElementById("filtroTiempo").value);
                    } else {
                        return r.text().then(t => Promise.reject(t));
                    }
                })
                .catch(err => {
                    console.warn("No se pudo eliminar en backend:", err);
                    alert("No se pudo eliminar en el servidor. (Revisa backend)");
                });
        }

        // Detectar cambios en el filtro
        document.getElementById("filtroTiempo").addEventListener("change", function() {
            mostrarInventario(this.value);
        });

        // Cargar al abrir la p√°gina
        mostrarInventario();
    </script>
    <script src="../render-window.js"></script>
</body>

</html>