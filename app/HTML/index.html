<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FarmStock</title>
  <link rel="stylesheet" href="../CSS/index.css" />
  <link rel="stylesheet" href="/FarmStock/app/CSS/darkmode.css" />
</head>

<body>
  <div class="window-controls">
    <button id="minimize" title="Minimizar">
      <svg viewBox="0 0 10 10">
        <rect x="2" y="6" width="6" height="1" fill="currentColor"/>
      </svg>
    </button>

    <button id="maximize" title="Maximizar">
      <svg viewBox="0 0 10 10">
        <rect x="2" y="2" width="6" height="6" fill="none" stroke="currentColor" stroke-width="1"/>
      </svg>
    </button>

    <button id="close" title="Cerrar">
      <svg viewBox="0 0 10 10">
        <line x1="2" y1="2" x2="8" y2="8" stroke="currentColor" stroke-width="1.5"/>
        <line x1="8" y1="2" x2="2" y2="8" stroke="currentColor" stroke-width="1.5"/>
      </svg>
    </button>
  </div>

  <!-- Contenedor general -->
  <div class="container">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="top-section">
        <div class="logo">
          <img src="../imagenes/Logo.png" alt="Logo del sitio" />
        </div>
        <ul class="menu-modulos">
          <li><a href="../HTML/index.html" class="active">Registro Herramientas</a></li>
          <li><a href="../HTML/registro-salida.html">Historial de herramientas</a></li>
          <li><a href="../HTML/indexInventario.html">Inventario</a></li>
          <li><a href="../HTML/Notificaciones.html">Notificaciones</a></li>
          <li><a href="../HTML/estats.html">EstadÃ­sticas</a></li>
        </ul>
      </div>
      <div class="sidebar-bottom">
        <a href="../HTML/quienes-somos.html" class="somos active">ðŸ‘¥ QuiÃ©nes Somos</a>
        <div class="night-mode">
          <span>ðŸŒ™ Modo noche</span>
        </div>
      </div>
    </aside>

    <!-- Contenido principal -->
    <main class="main-content">
      <div class="bienvenida">
        <img src="../imagenes/Maria.png" alt="Foto de usuario" class="foto-usuario" />
        <p><strong>Â¡Hola Maria!</strong></p>
      </div>

      <!-- Formulario principal -->
      <div class="area-superior">
        <div class="formulario-card">
          <form id="formHerramienta" class="formulario-horizontal">
            <div class="columna borde-derecho">
              <label for="nombre">Nombre de herramienta</label>
              <input type="text" id="nombre" name="nombre" placeholder="Escribe el nombre de la herramienta" required>

              <label for="estado">Estado</label>
              <select id="estado" name="estado" required>
                <option value="">Seleccionar</option>
                <option value="Disponible">Disponible</option>
                <option value="Mantenimiento">Mantenimiento</option>
                <option value="No_disponible">No disponible</option>
              </select>

              <label for="tipo">Tipo</label>
              <select id="tipo" name="tipo" required>
                <option value="">Seleccionar</option>
                <option value="Manual">Manual</option>
                <option value="Electrica">ElÃ©ctrica</option>
              </select>

              <label for="ubicacion">UbicaciÃ³n</label>
              <select id="ubicacion" name="ubicacion" required>
                <option value="">Seleccionar</option>
                <option value="Bodega">Bodega</option>
                <option value="Taller">Taller</option>
              </select>
            </div>

            <div class="columna borde-derecho">
              <label for="fecha_registro">Fecha de registro</label>
              <input type="date" id="fecha_registro" name="fecha_registro" required>

              <label for="numero_lote">NÃºmero de Lote</label>
              <select id="numero_lote" name="numero_lote" required>
                <option value="">Seleccionar</option>
                <option value="Lote 1">Lote 1</option>
                <option value="Lote 2">Lote 2</option>
              </select>

              <label for="cantidad">Cantidad</label>
              <input type="number" id="cantidad" name="cantidad" min="1" placeholder="Ejemplo: 10" required>
            </div>

            <div class="columna descripcion">
              <label for="descripcion">DescripciÃ³n de herramienta</label>
              <textarea id="descripcion" name="descripcion" placeholder="Escribe aquÃ­ la descripciÃ³n de la herramienta"></textarea>
              <div class="boton-registrar">
                <button type="submit" id="btnRegistrar" class="btn btn-success">Registrar</button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Herramientas de HOY -->
      <div class="area-inferior">
        <div class="herramientas-hoy">
          <h3>Herramientas registradas</h3>
          <div id="listaHoy" class="lista-tarjetas"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- Script conexiÃ³n con backend -->
  <script>
    const API_URL = "http://localhost:8080/herramienta";

    // Registrar herramienta
    document.getElementById("formHerramienta").addEventListener("submit", async (e) => {
      e.preventDefault();

      const datos = Object.fromEntries(new FormData(e.target).entries());

      // Asegurar formato correcto
      if (!datos.fecha_registro) {
        datos.fecha_registro = new Date().toISOString().split("T")[0];
      }

      // Convertir cantidad a nÃºmero
      datos.cantidad = parseInt(datos.cantidad);

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos),
        });

        if (response.ok) {
          alert("âœ… Herramienta registrada correctamente");
          e.target.reset();
          obtenerHerramientas();
        } else {
          const error = await response.text();
          console.error("Error del servidor:", error);
          alert("âŒ Error al registrar herramienta: " + error);
        }
      } catch (err) {
        console.error("Error de conexiÃ³n:", err);
        alert("âš  No se pudo conectar con el servidor.");
      }
    });

    // Obtener herramientas
    async function obtenerHerramientas() {
      const lista = document.getElementById("listaHoy");
      lista.innerHTML = "";
      try {
        const res = await fetch(API_URL + "/hoy");
        if (!res.ok) throw new Error("No se pudieron obtener las herramientas");
        const herramientas = await res.json();

        herramientas.forEach((h) => {
          const card = document.createElement("div");
          card.classList.add("tarjeta");
          card.innerHTML = `
            <h4>ðŸ›  ${h.nombre}</h4>
            <p><strong>Estado:</strong> ${h.estado}</p>
            <p><strong>Tipo:</strong> ${h.tipo}</p>
            <p><strong>UbicaciÃ³n:</strong> ${h.ubicacion}</p>
            <p><strong>Fecha registro:</strong> ${h.fecha_registro}</p>
            <p><strong>Lote:</strong> ${h.numero_lote}</p>
            <p><strong>Cantidad:</strong> ${h.cantidad}</p>
            <p><strong>DescripciÃ³n:</strong> ${h.descripcion || "Sin descripciÃ³n"}</p>
          `;
          lista.appendChild(card);
        });
      } catch (error) {
        console.error("Error cargando herramientas:", error);
        lista.innerHTML = "<p>No se pudieron cargar las herramientas</p>";
      }
    }

    // Cargar al iniciar
    obtenerHerramientas();
  </script>

  <script src="../modo-oscuro.js"></script>
  <script src="../render-window.js"></script>
</body>
</html>